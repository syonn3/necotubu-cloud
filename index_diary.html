<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Neco-Tubu つぶやき</title>
    <style>
      :root{
        --bg:#1c1a17; --surface:#2a211b; --card:#3b3128; --ink:#f5f1e6; --muted:#cbae82;
        --primary:#ff7f32; --accent:#a3c586; --line:#53473f; --shadow:0 3px 12px rgba(0,0,0,.35);
        --r:14px; --danger:#8d3a3a; --disabled:.45;
      }
      *{box-sizing:border-box}
      html,body{margin:0;background:var(--bg);color:var(--ink);
        font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",sans-serif;line-height:1.6}
      a{text-decoration:none;color:inherit}
      header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line);
        box-shadow:var(--shadow);padding:12px 14px}
      header .bar{max-width:720px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
      header h1{margin:0;font-size:18px;color:var(--primary)}
      .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--accent);
        color:#1c1a17;cursor:pointer;transition:.15s}
      .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
      .btn.disabled{opacity:var(--disabled);cursor:not-allowed;pointer-events:none;filter:grayscale(60%)}
      main{max-width:720px;margin:0 auto;background:var(--surface);min-height:100vh;padding:16px 12px 24px}
      .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;margin:16px 0;box-shadow:var(--shadow)}
      .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
      .right{justify-content:flex-end}
      .hint{color:var(--muted);font-size:12px}
      .avatar{width:80px;height:80px;border-radius:50%;overflow:hidden;border:2px solid var(--line);
        display:flex;align-items:center;justify-content:center;background:#6a6159;color:#fff;font-weight:800;font-size:22px}
      .avatar img{width:100%;height:100%;object-fit:cover}
      .profile p{margin:2px 0}
      .tw{font-size:16px;line-height:1.8;white-space:pre-wrap}
      input[type=file]{position:absolute;left:-9999px;width:1px;height:1px;opacity:0}
      .snap-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
      .snap{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);box-shadow:var(--shadow);background:#000}
      .snap img{width:100%;height:100%;display:block;object-fit:cover}
      .snap .del{position:absolute;top:6px;right:6px;padding:6px 8px;border:none;border-radius:10px;background:var(--danger);color:#fff;cursor:pointer}
      @media (max-width:480px){ .snap-grid{grid-template-columns:repeat(2,1fr);} }
      #cat-name, .card h2 { color: var(--primary); }
      .error-box{display:none;margin-top:8px;padding:10px 12px;border:1px solid #7a3a3a;background:#3b2727;color:#ffd4d4;border-radius:10px}
    </style>
  </head>
  <body>
    <header>
      <div class="bar">
        <h1>Neco-Tubu つぶやき</h1>
        <a href="index_home.html" class="btn">HOME</a>
      </div>
    </header>

    <main>
      <!-- プロフィール -->
      <section id="cat-profile" class="card">
        <div class="row">
          <div class="avatar" id="cat-avatar">？</div>
          <div class="profile">
            <p id="cat-name" style="font-weight:700;font-size:18px">ネコ</p>
            <p id="cat-gender" class="hint">性別: -</p>
            <p id="cat-age" class="hint">年齢: -</p>
            <p id="cat-breed" class="hint">猫種: -</p>
            <p id="cat-personality" class="hint">性格: -</p>
            <p id="cat-fav" class="hint">特徴: -</p>
            <p id="cat-territory" class="hint">テリトリー: -</p>
          </div>
        </div>
        <div class="row right" style="margin-top:10px">
          <a href="index_cats.html" class="btn">ほかのネコ</a>
          <a href="index_calendar.html" class="btn">カレンダー</a>
        </div>
      </section>

      <!-- つぶやき -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <h2 id="tw-title" style="margin:0 0 8px 0">つぶやき</h2>
            <p id="tw-date" style="font-weight:600;margin:0 0 6px 0"></p>
            <!-- ★開発用の速度表示（dev環境のみ表示） -->
            <p id="tw-perf" class="hint" style="display:none;margin:0"></p>
          </div>
          <button id="btn-regen" class="btn">もう１回聴く</button>
        </div>
        <p id="tw-loading" class="hint">つぶやきに聞き耳を立てています‥</p>
        <div id="tw-body" class="tw" style="display:none"></div>
        <div id="tw-error" class="error-box"></div>
      </section>

      <!-- スナップ -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">スナップ</h2>
          <div class="row">
            <label for="snap-file" class="btn">写真を追加</label>
            <input id="snap-file" type="file" accept="image/*">
          </div>
        </div>
        <div id="snap-grid" class="snap-grid" style="margin-top:10px"></div>
        <p class="hint">選ぶと自動で縮小保存（長辺1200px）。端末内のローカル保存です。</p>
      </section>

      <!-- SNS -->
      <section class="card">
        <h2 style="margin:0 0 8px 0">SNSシェア</h2>
        <div class="row">
          <button id="btn-fb" class="btn">Facebook</button>
          <button id="btn-ig" class="btn">Instagram</button>
          <button id="btn-tt" class="btn">TikTok</button>
          <button id="btn-x" class="btn">X</button>
        </div>
        <p class="hint">※スナップが無いときはシェアできません。</p>
      </section>
    </main>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/snaps.js"></script>

    <script>
      (function(){
        /* ====== 定数・ユーティリティ ====== */
        const CATS_KEY='necotubu_cats';
        const NS=(window.APP_CONFIG&&window.APP_CONFIG.STORAGE_NS)||'necotubu_v1';
        const HOME_NOTE   = NS+':home:note';
        const HOME_GENDER = NS+':home:gender';
        const HOME_WEATH  = NS+':home:weather';
        const HOME_DATE   = NS+':home:date';
        const HOME_OWNER_CALL = NS+':home:ownerCall'; // index_register.html 側で設定、ここでは読むだけ
        const TWEET_MAX = 320;

        function qs(){ return new URLSearchParams(location.search||''); }
        function clamp(txt,max){ const s=String(txt||''); return s.length<=max?s:s.slice(0,max-1)+'…'; }
        function todayJST(){ const now=new Date(); return new Date(now.toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'})); }
        function yobi(n){ return '日月火水木金土'.charAt(n%7); }
        function weatherEmoji(w){ return ({sunny:'☀',cloudy:'☁',rain:'☂',snow:'❄',storm:'⚡'}[w]||''); }
        function toDate(y,m,d){ if(!y||!m||!d) return null; const dt=new Date(+y,+m-1,+d); return isNaN(dt)?null:dt; }
        function yearsBetween(a,b){ if(!a||!b) return null; return (b-a)/(365.25*24*3600*1000); }
        function monthsBetween(a,b){ if(!a||!b) return null; return Math.max(0, Math.floor((b-a)/(30*24*3600*1000))); }
        function firstChar(s){ s=String(s||'').trim(); return s? s[0]:'？'; }
        function colFor(str){ const AVA=['#7E5A3C','#6B7A40','#AD6A3B','#5E5347','#8C7448','#7A614C','#9A6E4D']; let h=0; str=String(str||''); for(let i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))|0; return AVA[Math.abs(h)%AVA.length]; }
        function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

        function sanitize(t){
          return String(t||'')
            .replace(/にゃん?|ﾆｬ|ﾆｬﾝ|ニャン/gi,'')
            .replace(/\d{1,2}月\d{1,2}日/g,'きょう')
            .replace(/\b\d{1,2}:\d{2}\b/g,'')
            .replace(/(月曜|火曜|水曜|木曜|金曜|土曜|日曜)/g,'')
            .trim();
        }
        function dedupeEndings(s){
          let out=s;
          out=out.replace(/(だよ|だね|なの|かな)([よねのー〜]+)(?=。|！|？|$)/g,'$1');
          out=out.replace(/(よ|ね|の)+(だよ|だね|なの|かな)/g,'$2');
          out=out.replace(/(だよ|だね|なの|かな)。(?:\s*)(だよ|だね|なの|かな)。(?!\S)/g,'$1。');
          return out;
        }

        /* ====== やわらか化：共通仕上げロジック（語尾判定拡張） ====== */
        const SOFT_OK_RE = /(だよね|だよ|かな|かもね|んだよね|んだ|ないよ|いいんだ|かぁ|だぁ)$/;
        const VERBISH_RE = /(ておく|ていく|てくる|てみる|ちゃう|じゃう|しまう|できる|られる|れる|える|てる|ている|たい|たくなる|やすい|にくい|づらい|なる|する|いる|ある|いく|くる|おく|できた|なった|した|いった|きた)$/;
        const BASE_END_RE = /(る|た|う|く|す|つ|む|ぶ|ぬ|ぐ)$/;
        function finalizeSoftEnding(seg, gender){
          const tail=(seg.match(/[。！？]+$/)||[''])[0];
          let core=seg.slice(0, seg.length - tail.length);
          if(!core) return seg;

          // すでに柔らかければ触らない
          if(SOFT_OK_RE.test(core)) return seg;

          // 丁寧語→やわらか
          core = core.replace(/です$/,'だよ').replace(/ます$/,'だよ');

          // 名詞＋だ/です
          if(/(だ|です)$/.test(core)){
            core = core.replace(/です$/, (gender==='female'?'だよね':'だよ'))
                       .replace(/だ$/,   (gender==='female'?'だよね':'だよ'));
            return core + tail;
          }

          // 動詞・形容詞っぽい終わり
          if(VERBISH_RE.test(core) || BASE_END_RE.test(core)){
            core += (gender==='female' ? 'んだよね' : 'んだ');
            return core + tail;
          }

          // 形容詞（〜い）※否定の「ない」は別
          if(/[^な]い$/.test(core)){
            core += (gender==='female' ? 'んだよね' : 'んだ');
            return core + tail;
          }

          return core + tail;
        }

        /* ====== やわらか化（強） ====== */
        function adjustToneByGenderAge(text, gender, ageMonths, persona){
          let s=String(text||''); if(!s) return s;
          const g=(gender==='male')?'male':(gender==='female'?'female':'other');
          const m=Math.max(0, Number(ageMonths)||0);
          const strength = m<12 ? 0.25 : (m<24 ? 0.50 : 0.85);
          const softer = (g==='female')? ['だよね','かな','かもね','だよ','んだよね','んだ']
                        : (g==='male')  ? ['だよ','だよね','かな','かもね','んだ','んだよね']
                        : ['だよ','かな','かもね','んだ'];

          const parts=s.split(/(?<=[。！？])/);
          function tweak(seg){
            if(!seg) return seg;
            let out=seg;
            if(Math.random()<=strength){
              // 硬い言い回しをまず置換
              out = out
                .replace(/なのだ(?=([。！？」』]|$))/g, randPick(['なんだよね','なんだよ','なんだ']))
                .replace(/である(?=([。！？」』]|$))/g, randPick(softer))
                .replace(/だが(?=([、。！？」』]|$))/g, 'けど')
                .replace(/だと思う(?=([。！？」』]|$))/g, randPick(['気がする','かも']))
                .replace(/だろう(?=([。！？」』]|$))/g, randPick(['かも','かな']))
                .replace(/だな(?=([。！？」』]|$))/g, randPick(softer))
                .replace(/だぞ(?=([。！？」』]|$))/g, randPick(softer));
            }
            // 最終ふんわり（拡張判定）
            out = finalizeSoftEnding(out, gender);
            return out;
          }
          return parts.map(tweak).join('');
        }

        // クール以外はさらに硬さを下げる
        function softenHardEndings(text, persona, gender){
          let s=String(text||''); if(!s) return s;
          const cool = (persona==='cool');
          const keepRate = cool ? 0.20 : 0.02; // ほぼ置換
          function maybe(re, rep){
            s = s.replace(re, (m)=> (Math.random()<keepRate ? m : (typeof rep==='function'? rep(): rep)));
          }
          const soft = (gender==='female') ? ()=>randPick(['だよね','だよ','かな','んだよね'])
                                           : (gender==='male')   ? ()=>randPick(['だよ','だよね','かな','んだ'])
                                                                 : ()=>randPick(['だよ','かな','んだ']);

          maybe(/なのだ(?=([。！？」』]|$))/g, ()=> randPick(['なんだよね','なんだよ','なんだ']));
          maybe(/である(?=([。！？」』]|$))/g, ()=> soft());
          maybe(/だが(?=([、。！？」』]|$))/g, 'けど');
          maybe(/だと思う(?=([。！？」』]|$))/g, ()=> randPick(['気がする','かも']));
          maybe(/だろう(?=([。！？」』]|$))/g, ()=> randPick(['かも','かな']));

          // 硬い単語をやわらげ
          s = s.replace(/思案する/g, randPick(['考えちゃう','迷っちゃう']))
               .replace(/心象/g, 'きぶん')
               .replace(/結局、/g, randPick(['それで、','じゃあ、']))
               .replace(/ことにした(?=([。！？」』]|$))/g, randPick(['ことにしたよ','にしようかな']));

          // 文単位で最終ふんわり（拡張判定）
          s = s.split(/(?<=[。！？])/).map(seg=> finalizeSoftEnding(seg, gender)).join('');
          return s;
        }

        /* ====== 野良の表現補正 ====== */
        function fixStrayPhrases(text){
          let s=String(text||''); if(!s) return s;
          s = s.replace(/(飼い主|ご主人|主人|おうちの人|家の人)/g, '人');
          s = s.replace(/窓辺/g, '塀のうえ')
               .replace(/窓の外/g, '空のほう')
               .replace(/部屋/g, '路地')
               .replace(/膝の上/g, 'そば')
               .replace(/ソファ/g, '段ボール')
               .replace(/ベッド/g, 'ひさしの影')
               .replace(/カーテン/g, '看板の影');
          return s;
        }

        // 野良×甘え：つかずはなれずの甘えを1つは入れる
        function ensureStrayAffection(text, persona, territory, ageMonths){
          let s=String(text||''); if(!s) return s;
          const terr=String(territory||'').toLowerCase();
          if(terr!=='stray') return s;
          const hasCue = /(しっぽ|尻尾|耳を|耳だけ|のど|喉|ごろ|すり|すっと|そば|近づ|丸く|足もと|足元|鳴|小さく|ゆっくり瞬き)/.test(s);
          if(hasCue) return s;
          const m=Math.max(0, Number(ageMonths)||0);
          const strength = (persona==='clingy') ? (m<12?0.6:0.9) : 0.35;
          if(Math.random()>strength) return s;
          const candidates = [
            '少し距離をあけつつ、しっぽをそっと立てて合図してみたよ',
            '耳だけ向けて「ここにいるよ」と伝えてみた',
            '足もとで小さくまとまって、安心のしるしだけ置いておく',
            'のどを小さく鳴らして、近いけど近づきすぎない感じにした',
            'すりっと一歩だけ寄って、様子をうかがう',
            '視線を合わせてから、ゆっくり瞬きであいさつした'
          ];
          const add = randPick(candidates);
          if((s.length + add.length + 1) <= TWEET_MAX) s = s.replace(/\s*$/, '') + (s.endsWith('。')?'':'。') + add + '。';
          return s;
        }

        /* ====== 「特徴」を前面に：前半へ自然に差し込み ====== */
        function ensureFeatureMentionFront(text, features){
          let s=String(text||''); if(!s) return s;
          const raw=String(features||'').trim();
          if(!raw || raw==='-' ) return s;
          const tokens = raw.split(/[、,・／\/\s]+/).filter(Boolean).slice(0,2);
          if(tokens.length===0) return s;
          const found = tokens.some(t => s.includes(t));
          if(found) return s;
          const key = randPick(tokens);
          const variants = [
            `${key}を見ると落ち着くんだ`,
            `${key}はちょっと自慢でね`,
            `じつは${key}がチャームポイントなんだよ`,
            `${key}のおかげで元気が出るんだ`
          ];
          const add = randPick(variants);
          const parts = s.split(/(?<=[。！？])/);
          const pos = Math.min(1, parts.length-1);
          const candidate = (parts.slice(0,pos+1).join('') + (add.endsWith('。')?add:add+'。') + parts.slice(pos+1).join(''));
          if(candidate.length<=TWEET_MAX) return candidate;
          const add2 = `${key}はちょっと自慢でね。`;
          if((s.length + add2.length) <= TWEET_MAX) return s + add2;
          return s;
        }

        /* ====== 主人言及：頻度1/3・固定フレーズ回避・ネガは必ず寄りそう ====== */
        function ownerPhraseDejavuParaphrase(seg){
          return seg.replace(/(「)?[^」]*どう出る[^」]*?(」)?/g, randPick([
            '声だけ流れていった',
            '考えごとの気配がした',
            '小さく笑ったみたいに聞こえた',
            '様子を見るのかなって感じ'
          ]));
        }
        function sentenceHasOwner(seg, words){
          return words.some(w => seg.includes(w));
        }
        function textHasOwner(s, words){
          return sentenceHasOwner(s, words);
        }
        function lastOwnerMentionCount(catId, words, n=2){
          try{
            const box = JSON.parse(localStorage.getItem(`${NS}:tw:${catId}`)||'{}');
            const list = Object.values(box).filter(v=>v&&v.text).sort((a,b)=>(a.ts||0)-(b.ts||0));
            const last = list.slice(-n);
            let cnt=0;
            for(const v of last){ if(textHasOwner(String(v.text||''), words)) cnt++; }
            return cnt;
          }catch(_){ return 0; }
        }
        function limitAndParaphraseOwnerMention(text, ownerLabel, isOwnerNegative, territory, histCount){
          let s=String(text||''); if(!s) return s;
          const terr = String(territory||'').toLowerCase();
          const ownerWords = (()=>{
            if(terr==='stray') return ['人','おじちゃん','おねえさん'];
            const base = ['お父さん','お母さん','パパ','ママ','とうさん','かあさん','おとう','おかあ','ごしゅじん','おうちのひと'];
            if(ownerLabel && !base.includes(ownerLabel)) base.unshift(ownerLabel);
            return base;
          })();

          let sentences = s.split(/(?<=[。！？])/).filter(Boolean);
          let anyOwner=false;
          for(let i=0;i<sentences.length;i++){
            let seg=sentences[i];
            const hadOwner = sentenceHasOwner(seg, ownerWords);
            if(!hadOwner) continue;
            anyOwner=true;

            seg = ownerPhraseDejavuParaphrase(seg);

            if(isOwnerNegative){
              seg = seg.replace(/。?$/,'。');
              sentences[i]=seg;
            }else{
              const keepProb = Math.max(0, 0.34 - 0.34*Number(histCount||0));
              if(Math.random()>keepProb){
                sentences[i]='';
              }else{
                seg = seg
                  .replace(/(お父さん|お母さん|パパ|ママ|とうさん|かあさん|おとう|おかあ|ごしゅじん|おうちのひと|人|おじちゃん|おねえさん)の/g, '')
                  .replace(/(お父さん|お母さん|パパ|ママ|とうさん|かあさん|おとう|おかあ|ごしゅじん|おうちのひと|人|おじちゃん|おねえさん)が/g, '')
                  .replace(/「[^」]*」/g, randPick(['声だけ聞こえた','小さく聞こえた','気配だけあった']))
                  .replace(/(言っ|呼ん|つぶや)/g, '感じがした');
                sentences[i]=seg;
              }
            }
          }

          if(isOwnerNegative && !anyOwner){
            const add = randPick([
              `${ownerWords[0]||'人'}の声が少し沈んでたから、そっとそばにいたよ。`,
              `${ownerWords[0]||'人'}の元気が落ちてた気がして、静かに見てたんだ。`
            ]);
            if((s.length + add.length) <= TWEET_MAX) sentences.push(add);
          }

          s = sentences.filter(Boolean).join('');
          return s;
        }

        function similarity(a,b){
          a=String(a||''); b=String(b||''); if(!a||!b) return 0;
          const grams=(s)=>{ const g=new Set(); for(let i=0;i<s.length-1;i++) g.add(s.slice(i,i+2)); return g; };
          const A=grams(a), B=grams(b); let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
          return inter/Math.max(1, A.size + B.size - inter);
        }

        // 保存領域
        function twKey(id){ return `${NS}:tw:${id}`; }
        function saveTw(id, ymd, text, weather){
          const k=twKey(id); const box=JSON.parse(localStorage.getItem(k)||'{}');
          box[ymd]={ text, weather:weather||'', ts:Date.now() };
          localStorage.setItem(k, JSON.stringify(box));
        }
        function loadTw(id, ymd){
          try{ const k=twKey(id); const box=JSON.parse(localStorage.getItem(k)||'{}'); return box[ymd]?.text||''; }
          catch{ return ''; }
        }
        function recentAllTweets(limit=60){
          const res=[]; 
          for(let i=0;i<localStorage.length;i++){
            const k=localStorage.key(i);
            if(k && k.startsWith(`${NS}:tw:`)){
              try{
                const box=JSON.parse(localStorage.getItem(k)||'{}');
                Object.values(box).forEach(v=>{ if(v?.text) res.push(v.text); });
              }catch{}
            }
          }
          return res.slice(-limit);
        }

        // 性格・年齢制御
        function normPersonality(raw=''){
          const s=String(raw).toLowerCase();
          if(/やんちゃ|元気|活発/.test(s)) return 'energetic';
          if(/おだやか|やさしい|穏/.test(s)) return 'calm';
          if(/さびし|甘え|寂/.test(s)) return 'clingy';
          if(/マイペース|自由|気分/.test(s)) return 'mypace';
          if(/ツン|クール|気高|孤高/.test(s)) return 'cool';
          return 'neutral';
        }

        // 呼称：ユーザー選択（HOME_OWNER_CALL）＞既定ロジック（※野良は括り固定）
        function ownerNameByPersona(gender, persona, territory, override){
          const terr=String(territory||'').toLowerCase();
          if(terr==='stray'){
            if(gender==='male') return 'おじちゃん';
            if(gender==='female') return 'おねえさん';
            return '人';
          }
          const ov=String(override||'').trim(); if(ov) return ov.slice(0,8);
          const base = gender==='male' ? ['おとう','とうさん','パパ','おとうさん']
                    : gender==='female' ? ['おかあ','かあさん','ママ','おかあさん']
                    : ['ごしゅじん','おうちのひと'];
          if(persona==='energetic') return base[Math.floor(Math.random()*3)];
          if(persona==='cool') return base.slice(-2)[Math.floor(Math.random()*2)];
          if(persona==='clingy') return base.slice(1,3)[Math.floor(Math.random()*2)];
          return base[Math.floor(Math.random()*base.length)];
        }

        // 年齢→ひらがな率・赤ちゃん言葉強度
        function hiraRateForMonths(m){
          if(m<=0) return 1.0;
          if(m<6) return 1.0;
          if(m<12) return 1.0 - (m-6)*0.10;
          if(m<24) return Math.max(0, 0.40 - (m-12)*(0.40/12));
          return 0;
        }
        function babyTalkStrength(m){
          if(m<6) return 1.0;
          if(m<12) return 0.6;
          if(m<24) return (24-m)/24;
          return 0.0;
        }

        function seasonalHints(month,hour,wday,weatherKey){
          const hints=[];
          if(wday===5) hints.push('もう週末の空気');
          if(wday===6) hints.push('週末のゆるさ');
          if(wday===0) hints.push('週末のしずけさ');
          if(hour>=16 && hour<=18){
            if(month>=6 && month<=8) hints.push('明るい夕暮れ');
            if(month===12 ||月<=2) hints.push('夕暮れが早い');
          }
          if(hour>=5 && hour<=7 && month>=3 && month<=5) hints.push('朝焼けがきれい');
          if(hour>=11&&hour<=14){
            if(month>=7 && month<=8) hints.push('日差しが強い');
            if(month>=12||month<=2) hints.push('お昼でも空気がひやり');
          }
          if(weatherKey==='sunny')  hints.push('日差しがあたたかい');
          if(weatherKey==='cloudy') hints.push('雲がやわらかい');
          if(weatherKey==='rain')   hints.push('雨のしずく');
          if(weatherKey==='snow')   hints.push('雪が綿菓子みたい');
          if(weatherKey==='storm')  hints.push('風がごうっと吹く');
          return hints;
        }
        function eventWord(mm,dd){
          const key=`${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
          const ev={ '01-01':'お正月', '02-03':'節分', '03-03':'ひなまつり', '05-05':'こどもの日',
                     '07-07':'たなばた', '08-15':'お盆', '10-31':'ハロウィン', '12-24':'クリスマスイブ', '12-25':'クリスマス' };
          if(ev[key]) return ev[key];
          if(mm===3&&(dd===20||dd===21)) return '春分の日';
          if(mm===9&&(dd===22||dd===23)) return '秋分の日';
          return '';
        }

        /* ====== DeepSeek（GAS）呼び出し：POSTのみ（CORS対策：text/plain） ====== */
        function getApiBase(){
          const base = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || '';
          if(!base) throw new Error('AI API の接続先が未設定です（config.js の API_BASE_URL を確認）');
          return base.replace(/\/+$/,'');
        }
        function getGeminiModel(){
          const cfg = window.APP_CONFIG || {};
          return cfg.GEMINI_MODEL || cfg.MODEL || 'deepseek-chat';
        }
        function getTemp(){ return (window.APP_CONFIG && window.APP_CONFIG.GEMINI && window.APP_CONFIG.GEMINI.TEMPERATURE) || 0.9; }
        function getTimeout(){ return (window.APP_CONFIG && window.APP_CONFIG.TIMEOUT_MS) || 12000; }

        async function callPost(apiBase, prompt, {model, temperature, maxTokens}){
          const payload = {
            model,
            contents: [{ role: "user", parts: [{ text: String(prompt||'') }]}],
            temperature, maxTokens
          };
          const bodyText = JSON.stringify(payload);
          const ctrl = new AbortController();
          const t = setTimeout(()=>ctrl.abort(), getTimeout());
          try{
            const res = await fetch(apiBase + '/exec', {
              method:"POST",
              headers:{ "Content-Type":"text/plain" },
              body: bodyText,
              signal: ctrl.signal
            });
            const data = await res.json().catch(()=> ({}));
            if(!res.ok || data.error){ throw new Error((data && data.error && data.error.message) || ('HTTP '+res.status)); }
            return data;
          } finally {
            clearTimeout(t);
          }
        }
        function callAI(prompt, {maxTokens=180}={}){
          const apiBase = getApiBase();
          const model = getGeminiModel();
          const temperature = getTemp();
          return callPost(apiBase, prompt, {model, temperature, maxTokens});
        }
        function pickTextFromAI(data){
          return (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) || '';
        }

        // ネガ判定
        const NEG_WORDS = ['しんど','疲れ','つかれ','嫌','やめたい','むり','つら','さびし','かなしい','つかれた','もうだめ'];
        function hasNegative(s){ s=String(s||''); return NEG_WORDS.some(w=> s.includes(w)); }

        function promptBuilder(ctx){
          const {name, ageYears, ageMonths, personality, territory, weatherKey, note, ownerGender, ownerCall, features} = ctx;
          const now2=todayJST();
          const month = now2.getMonth()+1, hour = now2.getHours(), day = now2.getDate(), wday = now2.getDay();
          const persona = normPersonality(personality||'');
          const hints = seasonalHints(month,hour,wday,weatherKey);
          const ev = eventWord(month, day);
          const ownerLabel = ownerNameByPersona(ownerGender, persona, territory, ownerCall);
          const hiraRate = hiraRateForMonths(ageMonths);
          const babyPower = babyTalkStrength(ageMonths);
          const mustCare = hasNegative(note);
          const feat = String(features||'').trim();

          const terr = String(territory||'').toLowerCase();
          const strayRules = terr==='stray'
            ? [
                '- 本文で『飼い主』『主人』『おうちの人』は使わない（言うときは「人」「おじちゃん」「おねえさん」）。',
                '- 室内前提の描写（窓辺・ソファ・膝の上・ベッド・カーテンなど）は避け、外の情景（路地・軒下・塀のうえ・看板の影など）に寄せる。',
                '- 甘えんぼでも、つかずはなれずの距離感で好意を示すしぐさを入れる（例：しっぽを立てる・耳だけ向ける・小さく喉を鳴らす・足もとで丸くなる など）。'
              ].join('\n')
            : '';

          const toneRules = [
            '- 固すぎる語尾（「なのだ」「である」「〜だが」「〜だと思う」「〜だろう」）は使わない（クール性格のみ少量は可）。',
            '- むずかしい比喩は0〜1個まで。体の感覚語（におい・ひげ・耳・肉球など）を1つ入れる。',
            '- 視点は猫らしく、性格のクセを会話ににじませる（やんちゃ=体感先行／おだやか=やわらか／甘えんぼ=呼びかけ多め／マイペース=のんびり／クール=すこしだけ硬め）。',
            feat ? ('- 特徴（'+feat+'）を必ずどこかに織り込む。') : ''
          ].join('\n');

          const careRule = mustCare
            ? '- 主人のひとことがネガティブなら、必ず心配・慰めのニュアンスで短く寄りそう。'
            : '- 主人のひとことには3回に1回ていど軽く触れる。';

          return [
            'あなたは猫の詩的つぶやきを書くアシスタントです。',
            '【ねこ】名前:'+name+' / 性格:'+(personality||'不明')+' / テリトリー:'+(territory||'-'),
            '【推定年齢】'+(ageYears==null?'不明':(ageYears.toFixed(2)+'歳'))+'（約'+ageMonths+'か月）',
            '【天気】'+(weatherKey||'-')+' / 【季節・時間ヒント】'+(hints.join('、')||'なし')+' / 【イベント】'+(ev||'なし'),
            '【主人のひとこと】'+(String(note||'(なし)').slice(0,120))+' / 呼び方例:'+ownerLabel,
            feat ? ('【特徴】'+feat) : '',
            'スタイル制御：',
            `- ひらがな率の目安: 約${Math.round(hiraRate*100)}%（自動で漢字を控える）。赤ちゃん言葉の強度: ${babyPower.toFixed(2)}。`,
            '- 1歳未満はやさしい調子。1〜2歳は月齢に応じてだんだん大人びる。2歳以上は性格を強めに出す。',
            '- 「にゃ」「にゃん」などは禁止。具体的な年月日・曜日・時刻も禁止（抽象表現のみ）。',
            '- 一人称は常に自分の名前「'+name+'」。季節・時間帯・天気のニュアンスを必ず入れる。',
            careRule,
            toneRules,
            strayRules,
            '- 事実不明の体験談は書かない。過去や他の猫と似すぎる表現は避ける。',
            '出力：1段落のみ。最大'+TWEET_MAX+'文字程度。句読点は自然に。'
          ].filter(Boolean).join('\n');
        }

        /* ====== メイン ====== */
        document.addEventListener('DOMContentLoaded', ()=>{
          const errBox = document.getElementById('tw-error');
          function showError(msg){ errBox.textContent=msg; errBox.style.display='block'; }
          function clearError(){ errBox.style.display='none'; errBox.textContent=''; }

          const catId = qs().get('catId') || qs().get('catid');
          const calLink = document.querySelector('a[href="index_calendar.html"]');
          if (calLink && catId) calLink.href = 'index_calendar.html?catId=' + encodeURIComponent(catId);

          const cats=JSON.parse(localStorage.getItem(CATS_KEY)||'[]');
          const cat=cats.find(c=>c.id===catId);
          if(!cat){ alert('ネコ情報が見つかりません'); location.href='index_cats.html'; return; }

          const now=todayJST();
          const bday=toDate(cat.birthYear,cat.birthMonth,cat.birthDay);

          let created = cat.createdAt? new Date(cat.createdAt): null;
          if(!created || isNaN(created.getTime())){
            created = new Date(); cat.createdAt=created.toISOString();
            const i=cats.findIndex(c=>c.id===cat.id);
            if(i>=0){cats[i]=cat; localStorage.setItem(CATS_KEY,JSON.stringify(cats));}
          }
          const assumed=bday || new Date(created.getTime()-182*24*3600*1000);
          const ageYears=yearsBetween(assumed, now);
          const ageMonths=monthsBetween(assumed, now);

          // プロフィール描画
          const av=document.getElementById('cat-avatar');
          document.getElementById('cat-name').textContent=cat.name||'ネコ';
          document.getElementById('tw-title').textContent=(cat.name||'ネコ')+'のつぶやき';

          const genderLabel = { male: "おとこの子", female: "おんなの子", other: "わからない" };
          document.getElementById('cat-gender').textContent =
            "性別: " + (genderLabel[cat.gender] || "わからない");

          if(cat.avatar){
            av.innerHTML=''; const im=new Image();
            im.src=cat.avatar; im.alt='avatar'; im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover';
            av.appendChild(im);
          } else { av.textContent=firstChar(cat.name||'？'); av.style.background=colFor(cat.name||'?'); }

          // 年齢表示
          const ageEl=document.getElementById('cat-age');
          if(ageYears!=null){
            if(bday){
              if(ageYears<2){
                const m = Math.floor(ageYears*12); const y=Math.floor(m/12), mm=m%12;
                ageEl.textContent = y>0 ? `年齢: ${y}歳 ${mm}か月` : `年齢: ${mm}か月`;
              }else{
                const y=Math.floor(ageYears), m=Math.floor((ageYears-y)*12);
                ageEl.textContent='年齢: '+y+'歳 '+m+'か月';
              }
            }else{
              const months=Math.max(1, Math.floor((ageYears||0)*12));
              const y=Math.floor(months/12), mm=months%12;
              ageEl.textContent = y>0 ? `年齢: 約${y}歳 ${mm}か月（推定）` : `年齢: 約${months}か月（推定）`;
            }
          } else { ageEl.textContent='年齢: 不明'; }

          document.getElementById('cat-breed').textContent='猫種: '+(cat.breed||'-');
          document.getElementById('cat-personality').textContent='性格: '+(cat.personality||'-');
          document.getElementById('cat-fav').textContent='特徴: '+(cat.favorites||'-');
          const TERR_LABEL={ indoor:'完全家ネコ', outdoor:'外出可ネコ', stray:'野良ネコ', fantasy:'妄想ネコ' };
          document.getElementById('cat-territory').textContent='テリトリー: '+(TERR_LABEL[String(cat.territory||'').toLowerCase()]||'-');

          const dstr=localStorage.getItem(HOME_DATE)||''; const weath=(localStorage.getItem(HOME_WEATH)||'').toLowerCase();
          let disp=dstr;
          if(!disp){ disp = now.getFullYear()+'年'+(now.getMonth()+1)+'月'+now.getDate()+'日（'+yobi(now.getDay())+'）'; }
          document.getElementById('tw-date').textContent=disp+' '+weatherEmoji(weath);

          /* ====== Snaps 初期化（フェイルセーフ） ====== */
          let snaps;
          try{
            if (window.Snaps && typeof window.Snaps.init === 'function') {
              snaps = window.Snaps.init({ catId: cat.id, fileInputId: 'snap-file', gridId: 'snap-grid', maxSide: 1200 });
            } else { throw new Error('snaps_not_loaded'); }
          }catch(e){
            console.warn('Snaps init failed:', e && e.message ? e.message : e);
            snaps = { hasSnaps: ()=>false, onChange: ()=>{} };
            showError('写真機能の読み込みに失敗しました。古い写真が多い場合は容量がいっぱいの可能性があります。Ctrl+F5 で再読み込み、直らなければ古い写真を少し整理してください。');
          }

          const btnFB=document.getElementById('btn-fb');
          const btnIG=document.getElementById('btn-ig');
          const btnTT=document.getElementById('btn-tt');
          const btnX =document.getElementById('btn-x');
          function setDisabled(off){ [btnFB,btnIG,btnTT,btnX].forEach(b=> b.classList[off?'add':'remove']('disabled')); }
          setDisabled(!snaps.hasSnaps()); snaps.onChange(()=> setDisabled(!snaps.hasSnaps()));

          const loading=document.getElementById('tw-loading');
          const body=document.getElementById('tw-body');
          const regenBtn=document.getElementById('btn-regen');
          const perfLine=document.getElementById('tw-perf');
          const isDev=((window.APP_CONFIG&&window.APP_CONFIG.ENV)||'prod')==='dev';
          let lastGenerated='';

          function saveAndShow(ymd, text){
            saveTw(cat.id, ymd, text, weath);
            lastGenerated = text;
            loading.style.display='none'; body.style.display='block';
            body.textContent = text || '……（うとうと）';
            regenBtn.classList.remove('disabled');
          }
          function showErr(msg){
            loading.style.display='none';
            body.style.display='block';
            body.textContent='';
            regenBtn.classList.remove('disabled');
            const box=document.getElementById('tw-error'); box.textContent=msg; box.style.display='block';
          }
          function startLoading(){
            document.getElementById('tw-error').style.display='none';
            loading.textContent = `つぶやきに聞き耳を立てています‥（最大${Math.round(((window.APP_CONFIG&&window.APP_CONFIG.TIMEOUT_MS)||12000)/1000)}秒）`;
            loading.style.display='block';
            body.style.display='none'; body.textContent='';
            regenBtn.classList.add('disabled');
            if(perfLine){ perfLine.style.display='none'; perfLine.textContent=''; }
          }
          function showPerf(totalMs, meta){
            if(!isDev || !perfLine) return;
            const s=(n)=> (n/1000).toFixed(2)+'s';
            let line=`速度: 合計 ${s(totalMs)}`;
            if(meta && typeof meta.gas_ms==='number') line += ` / GAS ${s(meta.gas_ms)}`;
            if(meta && typeof meta.ai_ms==='number')  line += ` / AI ${s(meta.ai_ms)}`;
            perfLine.textContent=line;
            perfLine.style.display='block';
            console.log('[necotubu] perf', {total_ms:totalMs, timings:meta||null});
          }

          function ctxBase(){
            const ownerCall = (localStorage.getItem(HOME_OWNER_CALL)||'').trim(); // 反映のみ
            return {
              name: cat.name||'ネコ',
              ageYears,
              ageMonths: ageMonths==null? 0 : ageMonths,
              personality: cat.personality||'',
              territory: String(cat.territory||''),
              weatherKey: weath,
              note: localStorage.getItem(HOME_NOTE)||'',
              ownerGender: localStorage.getItem(HOME_GENDER)||'',
              ownerCall,
              features: cat.favorites||''
            };
          }

          async function generate({forceRegen=false}={}){
            const now2=todayJST();
            const ymd = now2.getFullYear()+'-'+String(now2.getMonth()+1).padStart(2,'0')+'-'+String(now2.getDate()).padStart(2,'0');
            const prevSaved = loadTw(cat.id, ymd);

            if(prevSaved && !forceRegen){
              body.textContent = prevSaved;
              loading.style.display='none'; body.style.display='block';
              regenBtn.classList.remove('disabled');
              if(isDev){ showPerf(0); }
              return;
            }

            startLoading();

            const others = recentAllTweets(60);
            const ctx = ctxBase();
            const basePrompt = promptBuilder(ctx);

            const t0=performance.now();
            try{
              let finalText=''; let lastData=null;
              for(let i=0;i<3;i++){
                const add = i? '\n【追加条件】前回までと似た言い回しを避け、新しい語彙で書き直してください（強度:'+i+'）。' : '';
                const data = await callAI(basePrompt + add, {maxTokens:180});
                lastData=data;
                const persona = normPersonality(ctx.personality||'');
                let draft = sanitize(String(pickTextFromAI(data)||'')); 
                if(!/[。！？]$/.test(draft)) draft+='。';
                draft = dedupeEndings(draft);

                // 後処理：口調・野良・主人・特徴
                draft = adjustToneByGenderAge(draft, cat.gender, ageMonths, persona);
                draft = softenHardEndings(draft, persona, cat.gender);
                if(String(cat.territory||'').toLowerCase()==='stray'){
                  draft = fixStrayPhrases(draft);
                  draft = ensureStrayAffection(draft, persona, 'stray', ageMonths);
                }

                const isOwnerNeg = hasNegative(localStorage.getItem(HOME_NOTE)||'');
                const ownerLabel = ownerNameByPersona(localStorage.getItem(HOME_GENDER)||'', persona, cat.territory, (localStorage.getItem(HOME_OWNER_CALL)||'').trim());
                const histCount = lastOwnerMentionCount(cat.id, (String(cat.territory||'').toLowerCase()==='stray'
                                ? ['人','おじちゃん','おねえさん']
                                : [ownerLabel,'お父さん','お母さん','パパ','ママ','とうさん','かあさん','おとう','おかあ','ごしゅじん','おうちのひと']), 2);
                draft = limitAndParaphraseOwnerMention(draft, ownerLabel, isOwnerNeg, cat.territory, histCount);

                draft = ensureFeatureMentionFront(draft, ctx.features);

                // 文末仕上げ（拡張）を念押し
                draft = draft.split(/(?<=[。！？])/).map(seg=> finalizeSoftEnding(seg, cat.gender)).join('');

                // 類似チェック
                const simPrev = prevSaved ? similarity(draft, prevSaved) : 0;
                const simLast = lastGenerated ? similarity(draft, lastGenerated) : 0;
                const simOthers = Math.max(...others.map(o=> similarity(draft,o)||0),0);
                if(simPrev<0.50 && simLast<0.50 && simOthers<0.48){ finalText=draft; break; }
              }

              if(!finalText) throw new Error('条件に合う文案が得られませんでした');

              finalText = clamp(finalText, TWEET_MAX);
              saveAndShow(ymd, finalText);

              const totalMs=performance.now()-t0;
              const meta=(lastData && (lastData.timings||lastData._timings||null))||null;
              showPerf(totalMs, meta);

            }catch(e){
              const totalMs=performance.now()-t0;
              showPerf(totalMs, null);
              const msg = (e && e.name==='AbortError') ? '少し時間がかかっています。通信状況を確認して、もう一度ためしてください。'
                        : 'AI生成に失敗しました。設定やネットワークをご確認ください。' + (e && e.message ? '（詳細: ' + e.message + '）' : '');
              showErr(msg);
            }
          }

          generate();
          regenBtn.addEventListener('click', ()=>{
            if(regenBtn.classList.contains('disabled')) return;
            generate({forceRegen:true});
          });
        });
      })();
    </script>
  </body>
</html>
